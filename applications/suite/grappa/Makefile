GRAPPA_HOME?=$(shell /bin/bash -c '(while [[ ! -e include.mk && "`pwd`" != "/" ]]; do cd ..; done; pwd )')
# check if autodetect GRAPPA_HOME is consistent
AUTO_HOME=$(shell /bin/bash -c '(while [[ ! -e include.mk && "`pwd`" != "/" ]]; do cd ..; done; pwd )')
ifneq ($(GRAPPA_HOME), $(AUTO_HOME))
$(warning warning: Environment variable GRAPPA_HOME was set but does not match the autodetected home: env=$(GRAPPA_HOME), auto=$(AUTO_HOME))
endif

#include common Grappa definitions
include $(GRAPPA_HOME)/include.mk

SRUN_FLAGS:=--time=00:05:00

TARGET:= suite.exe

#default rule: just build
$(TARGET):

CFLAGS += -w
CFLAGS += -I$(GRAPPA_HOME)/system
CFLAGS += -g -Wall -Drestrict=__restrict__ -ffast-math

LDFLAGS = -g

GENERATOR_SOURCES = graph_generator.o make_graph.o splittable_mrg.o utils.o
GEN = ../generator

SOURCES = main.o centrality.o computeGraph.o connectedComponentsKahan.o genScalData.o graphManip.o pathIsomorphism.o timer.o triangles.o ../compat/mersenne.o centrality_multi.o
HEADERS = defs.hpp

include $(GRAPPA_HOME)/system/Makefile

suite.exe: $(SOURCES) $(HEADERS) $(GRAPPA_HOME)/system/libGrappa.a generator.a
	$(ENV_VARIABLES) $($(MPITYPE)_LD) $(LDFLAGS) $(CFLAGS) $(SOURCES) $(GRAPPA_HOME)/system/libGrappa.a generator.a $(LIBRARIES) -o $@ $(LIBS)

$(GRAPPA_HOME)/system/libGrappa.a: force
	cd ../../../system; $(MAKE) lib

generator.a: $(GEN)/graph_generator.c $(GEN)/make_graph.c $(GEN)/splittable_mrg.c $(GEN)/utils.c
	pushd $(GEN); $(MAKE) -f Makefile.grappa genlib
	popd; cp $(GEN)/generator.a generator.a

force: ;

allclean: clean
	pushd ../../../system; $(MAKE) clean; popd

